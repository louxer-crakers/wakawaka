Resources:

  OrderStateMachineRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: order-step-function-role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: states.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: StepFunctionInvokeLambda
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: "*"

  OrderProcessingStateMachine:
    Type: AWS::StepFunctions::StateMachine
    Properties:
      StateMachineName: order-processing-workflow
      RoleArn: !GetAtt OrderStateMachineRole.Arn
      StateMachineType: STANDARD
      DefinitionString: !Sub |
        {
          "Comment": "Serverless Order Processing Workflow - Orchestrates end-to-end order processing with error handling",
          "StartAt": "ValidateOrder",
          "States": {
            "ValidateOrder": {
              "Type": "Task",
              "Resource": "arn:aws:states:::lambda:invoke",
              "Parameters": {
                "FunctionName": "${OrderManagementLambda}",
                "Payload.$": "$"
              },
              "ResultPath": "$.validationResult",
              "Next": "ProcessPayment",
              "Catch": [
                {
                  "ErrorEquals": ["States.ALL"],
                  "ResultPath": "$.error",
                  "Next": "OrderFailed"
                }
              ],
              "OutputPath": "$.validationResult.Payload"
            },

            "ProcessPayment": {
              "Type": "Task",
              "Resource": "arn:aws:states:::lambda:invoke",
              "Parameters": {
                "FunctionName": "${ProcessPaymentLambda}",
                "Payload.$": "$"
              },
              "ResultPath": "$.paymentResult",
              "Next": "PaymentChoice",
              "Catch": [
                {
                  "ErrorEquals": ["States.ALL"],
                  "ResultPath": "$.error",
                  "Next": "PaymentFailed"
                }
              ],
              "OutputPath": "$.paymentResult.Payload"
            },

            "PaymentChoice": {
              "Type": "Choice",
              "Choices": [
                {
                  "Variable": "$.paymentStatus",
                  "StringEquals": "SUCCESS",
                  "Next": "UpdateInventory"
                }
              ],
              "Default": "PaymentFailed"
            },

            "UpdateInventory": {
              "Type": "Task",
              "Resource": "arn:aws:states:::lambda:invoke",
              "Parameters": {
                "FunctionName": "${UpdateInventoryLambda}",
                "Payload.$": "$"
              },
              "ResultPath": "$.inventoryResult",
              "Next": "CheckInventoryStatus",
              "Catch": [
                {
                  "ErrorEquals": ["States.ALL"],
                  "ResultPath": "$.error",
                  "Next": "InventoryFailed"
                }
              ],
              "OutputPath": "$.inventoryResult.Payload"
            },

            "CheckInventoryStatus": {
              "Type": "Choice",
              "Choices": [
                {
                  "Variable": "$.inventoryStatus",
                  "StringEquals": "SUCCESS",
                  "Next": "SendConfirmation"
                }
              ],
              "Default": "InventoryFailed"
            },

            "SendConfirmation": {
              "Type": "Task",
              "Resource": "arn:aws:states:::lambda:invoke",
              "Parameters": {
                "FunctionName": "${SendNotificationLambda}",
                "Payload.$": "$"
              },
              "End": true
            },

            "PaymentFailed": {
              "Type": "Task",
              "Resource": "arn:aws:states:::lambda:invoke",
              "Parameters": {
                "FunctionName": "${SendNotificationLambda}",
                "Payload.$": "$"
              },
              "Next": "OrderFailed"
            },

            "InventoryFailed": {
              "Type": "Task",
              "Resource": "arn:aws:states:::lambda:invoke",
              "Parameters": {
                "FunctionName": "${SendNotificationLambda}",
                "Payload.$": "$"
              },
              "Next": "OrderFailed"
            },

            "OrderFailed": {
              "Type": "Fail",
              "Cause": "Order processing workflow failed",
              "Error": "ORDER_PROCESSING_FAILED"
            }
          }
        }

Outputs:
  StateMachineArn:
    Value: !Ref OrderProcessingStateMachine
